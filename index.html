<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flower of Mortality with Time Spiral</title>
    <!-- D3.js CDN -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- D3.js Shape -->
    <script src="https://d3js.org/d3-shape.v2.min.js"></script>
    <!-- D3.js Transition -->
    <script src="https://d3js.org/d3-transition.v2.min.js"></script>
    <!-- D3.js Color Scheme -->
    <script src="https://d3js.org/d3-scale-chromatic.v2.min.js"></script>
    <style>
        body {
            margin: 0;
            background-color: #87CEEB; /* Sky blue for day */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            transition: background-color 1s;
        }
        header {
            background-color: #4682b4;
            padding: 20px;
            text-align: center;
            color: #fff;
        }
        header h1 {
            margin: 0;
            font-size: 3em;
            font-weight: lighter;
        }
        .container {
            position: relative;
            width: 100%;
            height: calc(100vh - 80px);
            overflow: hidden;
        }
        svg {
            display: block;
            margin: 0 auto;
        }
        .tooltip {
            position: absolute;
            background-color: rgba(70, 130, 180, 0.9);
            color: #fff;
            padding: 8px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 16px;
            text-align: center;
        }
        .timeline {
            position: absolute;
            bottom: 60px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 22px;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
        }
        /* Sun */
        .sun {
            transition: transform 1s;
            cursor: pointer;
        }
        /* Background Transition */
        .day {
            background-color: #87CEEB; /* Sky blue */
        }
        .night {
            background-color: #191970; /* Midnight blue */
        }
        /* Spiral Style */
        .spiral-path {
            fill: none;
            stroke: #8B4513;
            stroke-width: 4;
            cursor: pointer;
        }
        .spiral-handle {
            fill: #FFD700;
            stroke: #DAA520;
            stroke-width: 2;
            cursor: pointer;
        }
        /* Flowers */
        .flower-bed {
            /* No need for opacity transition */
        }
        /* Petal Labels */
        .petal-label {
            font-size: 18px;
            fill: #000;
            text-anchor: middle;
        }
        /* Animated Bird */
        .bird {
            fill: #000;
            cursor: pointer;
        }
        /* Slider Style */
        .slider-container {
            position: absolute;
            bottom: 50px; /* Moved up by 1 cm (~38px) */
            width: 100%;
            text-align: center;
        }
        .slider {
            width: 80%;
        }
    </style>
</head>
<body class="day">

    <header>
        <h1>Flower of Mortality with Time Spiral</h1>
    </header>

    <div class="container">
        <div id="flower"></div>
        <div class="tooltip" id="tooltip"></div>
        <div class="timeline" id="timeline"></div>
        <div class="slider-container">
            <input type="range" min="2000" max="2020" step="0.1" value="2000" class="slider" id="timeSlider">
        </div>
    </div>

    <script>
        // Sample Data: Mortality Causes Over Time (Years 2000 - 2020)
        const dataOverTime = [
            {
                year: 2000,
                data: [
                    { cause: "Cardiovascular Diseases", value: 15.0 },
                    { cause: "Cancers", value: 8.5 },
                    { cause: "Respiratory Diseases", value: 3.5 },
                    { cause: "Infectious Diseases", value: 5.0 },
                    { cause: "Diabetes", value: 1.0 },
                    { cause: "Other Causes", value: 6.0 }
                ]
            },
            // ... (rest of the dataOverTime array)
        ];

        // Dimensions
        const width = window.innerWidth;
        const height = window.innerHeight - 80; // Subtract header height
        const centerX = width * 0.5; // Centered sunflower
        const centerY = height * 0.6; // Positioned slightly lower
        const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

        // Time Variables
        let currentTime = dataOverTime[0].year;

        // Time Scale
        const timeExtent = [2000, 2020];
        const timeScale = d3.scaleLinear()
            .domain(timeExtent)
            .range([0, 1]);

        // Declare currentFlowerBed and currentFlowerData before they are used
        let currentFlowerBed;
        let currentFlowerData;

        // Slider Control
        const timeSlider = document.getElementById('timeSlider');
        timeSlider.addEventListener('input', function() {
            const t = +this.value;
            updateTime(t);
            updateSpiralHandle(t);
        });

        // SVG Container
        const svg = d3.select("#flower")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        // (Rest of the initial SVG setup code...)

        // Function to Pull Off Petal and Grow Flowers
        function pullOffPetal(petal, d, index) {
            const angleScale = d3.scaleLinear().domain([0, dataOverTime[0].data.length]).range([0, 2 * Math.PI]);
            const angle = angleScale(index);
            const length = 200; // Adjusted to position flowerbed higher
            const targetX = width * 0.75; // Position in top right corner
            const targetY = height - 150; // Position near the bottom, on the grass

            // Remove existing flower bed if any
            if (currentFlowerBed) {
                currentFlowerBed.remove();
            }

            // Store current flower data
            currentFlowerData = d;

            // Starting position relative to petal's current transform
            const x0 = centerX;
            const y0 = centerY;

            // Random control points for Bezier curve
            const controlPoint1X = x0 + (Math.random() - 0.5) * 200;
            const controlPoint1Y = y0 + (Math.random() - 0.5) * 200;
            const controlPoint2X = targetX + (Math.random() - 0.5) * 200;
            const controlPoint2Y = targetY + (Math.random() - 0.5) * 200;

            // Create path data string
            const pathData = `M${x0},${y0} C${controlPoint1X},${controlPoint1Y} ${controlPoint2X},${controlPoint2Y} ${targetX},${targetY}`;

            // Create an invisible path element
            const tempPath = svg.append("path")
                .attr("d", pathData)
                .attr("fill", "none")
                .attr("stroke", "none");

            const totalLength = tempPath.node().getTotalLength();

            petal.transition()
                .duration(2000)
                .attrTween("transform", function() {
                    return function(t) {
                        const point = tempPath.node().getPointAtLength(t * totalLength);
                        const dx = point.x - centerX;
                        const dy = point.y - centerY;
                        return `translate(${dx}, ${dy})`;
                    };
                })
                .styleTween('opacity', function() {
                    return d3.interpolate(1, 0);
                })
                .on("end", function() {
                    // Remove the temp path
                    tempPath.remove();
                    // Grow Little Flowers
                    currentFlowerBed = growFlowers(targetX, targetY, d);
                    petal.remove(); // Remove the petal after the flower bed is created
                });
        }

        // (Rest of the code remains the same...)

    </script>
</body>
</html>
